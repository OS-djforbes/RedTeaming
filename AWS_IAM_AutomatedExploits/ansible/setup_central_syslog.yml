- hosts: all
  gather_facts: true
  become: yes
  remote_user: "{{ user }}"  
  vars:
    - new_hostname: syslog
    - rsyslog_receiver: yes
    - firewall_allowed_tcp_ports:
      - "22"
      - "514"
      - "9200"
      - "80"
      - "443"
      - "8444"
    - firewall_allowed_udp_ports:
      - "514"
      - "2055"    
  roles:
    - role: bsmeding.webmin
    - role: arillso.motd    
    - role: geerlingguy.firewall
    - role: robertdebock.roles.rsyslog
    - role: robertdebock.roles.fail2ban
    - role: reallyenglish.logrotate
      logrotate_default_su: root adm    
  pre_tasks:
    - name: Run the equivalent of "apt-get update" as a separate step
      apt:
        update_cache: yes
    - name: Install required packages
      apt:
        pkg:
        - python3-pip
        - python3-dev
        - net-tools
        - htop
        - git         
  tasks:
    - name: Copy ISSUE
      copy:
        src: resources/issue
        dest: /etc/issue
        owner: root
        group: root
        mode: 0644    
    - name: change hostname
      hostname:
        name: "{{ new_hostname }}"  
    - name: disable IPv6
      sysctl:
        name: "{{item.name}}"
        value: "{{item.value}}"
        state: present
        reload: yes
      with_items:
        - { "name": net.ipv6.conf.all.disable_ipv6, "value": 1 }
        - { "name": net.ipv6.conf.default.disable_ipv6, "value": 1 }
        - { "name": net.ipv6.conf.lo.disable_ipv6, "value": 1 }
    - name: copy logrotate cron.daily script
      become: true
      copy:
        dest: /etc/cron.daily/logrotate
        src: resources/logrotate
        owner: root
        group: root
        mode: 0755
    - name: Cleanup unused packages
      apt:
        autoremove: yes
    - name: change hostname
      hostname:
        name: "{{ new_hostname }}"        
    - name: Update /etc/hosts
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: '^127.0.1.1'
        line: "127.0.1.1 {{ new_hostname }}"                         
    - name: restart machine
      reboot:
