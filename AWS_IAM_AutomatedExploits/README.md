# gremlins
This repo will contain the gremlins project terraform and ansible.
Use Terraform to create your own *vulnerable by design* AWS IAM privilege escalation infrastructure 
Use ansible to initially configure resources.
Also Use ansible to exploit said resources.


This repo uses the Terraform and Ansible binary along with your AWS credentials to deploy dozens of AWS resources into your selected AWS account. Within minutes. 

:fox_face:  **Currently supported privilege escalation paths:         5**

# Table of Contents
- [Gremlins](#gremlins)
- [Recommended Approach](#recommended-approach)
- [Detailed Usage Instructions](#detailed-usage-instructions)
- [Quick Start](#quick-start)
  - [Ansible Exploit Cleanup](#Ansible-Exploit-Cleanup)
  - [Terraform Cleanup](#Terraform-Cleanup)
  - [What resources were just created?](#what-resources-were-just-created)
  - [Free resource modules](#free-resource-modules)
- [Supported Privilege Escalation Paths](#supported-privilege-escalation-paths)
- [FAQ](#faq)

# Recommended Approach

1. **Select or create an AWS account** - Do NOT use an account that has any production resources or sensitive data.
2. **Create your vulnerable infrastructure** - Use terraform to create your vulnerable infratructure.
3. **Attack your resources** - Run ansible playbooks in "exploit_playbooks" directory to launch atomated attacks against resources.
4. **Clean up** - Terraform destroy your infrastructure when done but before that you will need to clean up the mess that ansible exploits have made. Instructions are here: [Ansible Exploit Cleanup](#ansible-exploit-cleanup)
5. **Level up** - For personal gain, look into running these tools against your account (i.e., [Cloudsplaining](https://github.com/salesforce/cloudsplaining/), [AWSPX](https://github.com/FSecureLABS/awspx), [Principal Mapper](https://github.com/nccgroup/PMapper), [Pacu](https://github.com/RhinoSecurityLabs/pacu)).

# Detailed Usage Instructions

[Blog Post: IAM Vulnerable - An AWS IAM Privilege Escalation Playground](https://labs.bishopfox.com/tech-blog/iam-vulnerable-an-aws-iam-privilege-escalation-playground)

# Quick Start

This quick start outlines an opinionated approach to getting IAM Vulnerable up and running in your AWS account as quickly as possible. You might have many of these steps already completed, or you might want to tweak things to work with your current configuration. Check out the [Other Use Cases](#other-use-cases) section in this repository for some additional configuration options.

1. Select or create an AWS account. (Do NOT use an account that has any production resources or sensitive data!)
2. [Create a non-root user with administrative access](https://docs.aws.amazon.com/IAM/latest/UserGuide/getting-started_create-admin-group.html) that you will use when running Terraform.
3. [Use an existing or Create an access key for that user](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html).
4. [Make sure AWS CLI is installed](https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html).
5. [Configure your AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html)
6. Confirm your CLI is working as expected by executing `aws sts get-caller-identity`.
7. [Install the Terraform binary](https://www.terraform.io/downloads.html) and add the binary location to your path.
8. [Install the Ansible binary](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#installing-ansible-on-specific-operating-systems) and add the binary location to your path if necassary.
9. `git clone git@github.com:TheDreamPort/gremlins.git`
10. `cd gremlins/`
11. `terraform init`
12. (Optional) `terraform plan`
13. `terraform apply`
14. Add the vulnerable profiles to your AWS credentials file, and change the account number.
      * The following commands make a backup of your current AWS credentials file, then takes the example credentials file from the repo and replaces the placeholder account with your target account number, and finally adds all of the IAM Vulnerable privesc profiles to your credentials file so you can use them:
      * `cp ~/.aws/credentials ~/.aws/credentials.backup`
      * `printf "\n" >> ~/.aws/credentials & tail -n +7 aws_credentials_file_example | sed s/account_id/$(aws sts get-caller-identity | grep Account | awk -F\" '{print $4}')/g >> ~/.aws/credentials`
## Ansible Exploit Cleanup
Whenever you are ready to clean up the mess that the ansible exploits made you can run this command for each playbook like so:

 (I need to create tasks in my playbooks that delete things like access keys, event source mappings and removes attached policies and that are triggered only when a certain variable is passed to the ansible playbook command)


## Terraform Cleanup

Whenever you want to remove all of the IAM Vulnerable-created resources, you can run these commands:
1. `cd gremlins/`
1. `terraform destroy`

## What resources were just created?

The Terraform binary just used your default AWS account profile credentials to create:
* **5 users, roles, and policies** each with a unique exploit path to administrative access of the playground account

By default, every role created by this Terraform module is assumable by the user or role you used to run Terraform.


## Free Resource Modules

There is no cost to anything deployed within `free-resources`:

| Name | Default Status | Estimated Cost | Description |
| --- | --- | --- | --- |
| privesc-paths  | Enabled | None | Contains all of the IAM privesc paths |

# Supported Privilege Escalation Paths

| Path Name | IAM Vulnerable Profile Name | Non-Default Modules Required | Exploitation References |
| --- | --- | --- | --- |
| **Category: IAM Permissions on Other Users** |   |   |   |
| IAM-CreateAccessKey | privesc4  | None  | [Well, That Escalated Quickly - Privesc 04](https://labs.bishopfox.com/tech-blog/privilege-escalation-in-aws)  |
| **Category: PassRole to Service** |   |  |   |
| EC2-CreateInstanceWithExistingProfile| privesc3  | None  | [Well, That Escalated Quickly - Privesc 03](https://labs.bishopfox.com/tech-blog/privilege-escalation-in-aws)  |
| Lambda-PassRoleToNewLambdaThenTrigger | privesc16  |  None |  [Well, That Escalated Quickly - Privesc 16](https://labs.bishopfox.com/tech-blog/privilege-escalation-in-aws)  |
| **Category: Permissions on Policies** |    |   |
| IAM-CreateNewPolicyVersion| privesc1  |  None | [Well, That Escalated Quickly - Privesc 01](https://labs.bishopfox.com/tech-blog/privilege-escalation-in-aws)  |

